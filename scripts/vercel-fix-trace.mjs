import { promises as fs } from "node:fs";
import path from "node:path";

/**
 * Vercel's Next.js builder runs an additional file-tracing step AFTER `next build`.
 * In some Next.js 15.1.x builds (especially with route-groups), the tracer can
 * try to `lstat` `*_client-reference-manifest.js` files under `.next/server/app/**`
 * that are not emitted, causing ENOENT (build fails even though `next build` succeeded).
 *
 * This script creates minimal placeholder manifests for any missing ones next to
 * `page.js` / `layout.js` so Vercel's tracing step doesn't crash.
 */

const projectRoot = process.cwd();
const appServerRoot = path.join(projectRoot, ".next", "server", "app");

const PLACEHOLDER = `// Auto-generated by scripts/vercel-fix-trace.mjs\n` +
  `// See: https://nextjs.org/docs/app/building-your-application/deploying\n` +
  `module.exports = {};\n`;

async function exists(p) {
  try {
    await fs.stat(p);
    return true;
  } catch {
    return false;
  }
}

async function walk(dir) {
  const entries = await fs.readdir(dir, { withFileTypes: true });
  const out = [];
  for (const e of entries) {
    const full = path.join(dir, e.name);
    if (e.isDirectory()) out.push(...(await walk(full)));
    else out.push(full);
  }
  return out;
}

async function ensureSiblingManifest(jsFile, baseName) {
  const dir = path.dirname(jsFile);
  const manifest = path.join(dir, `${baseName}_client-reference-manifest.js`);
  if (await exists(manifest)) return false;
  await fs.writeFile(manifest, PLACEHOLDER, "utf8");
  return true;
}

async function main() {
  if (!(await exists(appServerRoot))) {
    // Not an app-router build or `.next` is missing.
    return;
  }

  const files = await walk(appServerRoot);
  let created = 0;

  for (const f of files) {
    const bn = path.basename(f);
    if (bn === "page.js") {
      if (await ensureSiblingManifest(f, "page")) created++;
    }
    if (bn === "layout.js") {
      if (await ensureSiblingManifest(f, "layout")) created++;
    }
  }

  if (created > 0) {
    console.log(`[vercel-fix-trace] Created ${created} missing client-reference manifest file(s).`);
  }
}

await main();
